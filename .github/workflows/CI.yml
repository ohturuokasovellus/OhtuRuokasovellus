name: Deployment pipeline

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:
    branches: [main]
    types: [opened, synchronize]

jobs:
    simple_deployment_pipeline:
      runs-on: ubuntu-20.04
      env:
        SECRET_KEY: ${{ secrets.SECRET_KEY }}
        BACKEND_POSTGRES_URL: ${{ secrets.BACKEND_POSTGRES_URL }}
      steps:
        - uses: actions/checkout@v4
        - uses: actions/setup-node@v4
          with:
            node-version: '20'
        - uses: akanieski/setup-postgres-cli@v0.1.2
          with:
            # Password passed to postgres cli
            password: ${{ secrets.BACKEND_POSTGRES_PASSWORD}}
            # Actions to take
            commands: psql -U ${{ secrets.BACKEND_POSTGRES_USERNAME}} -d ${{ secrets.BACKEND_POSTGRES_DATABASE}} -a -f schema.sql
            

        - name: Install dependencies 
          run: npm install  
  
        - name: Check style
          run: npm run lint

        - name: Test
          run: npm run test

        - name: E2E tests
          run: npm run test:e2e
